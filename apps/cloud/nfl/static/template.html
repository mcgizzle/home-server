<!doctype html>
<html data-theme="forest">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/static/main.css" type="text/css">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="icon" href="/static/assets/favicon.ico" sizes="32x32" type="image/x-icon">
    <title>NFL Ratings</title>
</head>

<body class="min-h-screen bg-base-100">
    <!-- Mobile-first Header -->
    <header class="sticky top-0 z-50 bg-base-100/95 backdrop-blur border-b border-base-300">
        <div class="flex items-center justify-between px-4 py-3">
            <a href="/" class="text-lg font-bold">NFL Ratings</a>
            <div class="tabs tabs-boxed tabs-sm bg-base-200">
                <a class="tab tab-active" onclick="switchTab('latest', this)">Games</a>
                <a class="tab" onclick="switchTab('browse', this)">Browse</a>
            </div>
        </div>
    </header>

    <!-- Results Tab -->
    <div id="latest-content" class="tab-content">
        <!-- Week Info - Compact for mobile -->
        <div class="flex items-center justify-center gap-2 py-3 text-xs text-base-content/60 border-b border-base-200">
            <a href="/" id="latestBtn" class="hidden btn btn-ghost btn-xs gap-1 text-emerald-500 hover:text-emerald-400">
                <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"/></svg>
                Latest
            </a>
            <span>{{ .Current.Season }}</span>
            <span>‚Ä¢</span>
            <span>{{ .Current.PeriodDisplay }}</span>
            <span>‚Ä¢</span>
            <span class="capitalize">{{ .Current.PeriodType }}</span>
        </div>

        <!-- Games List - Stack on mobile -->
        <div class="px-3 py-4 space-y-3 max-w-lg mx-auto">
            {{ range $index, $element := .Results }}
            {{ $categoryKey := $element.Rating.Category }}
            {{ $isMustWatch := eq $categoryKey "must-watch" }}
            {{ $isRecommended := eq $categoryKey "recommended" }}
            {{ $isGood := eq $categoryKey "good" }}
            {{ $isOkay := eq $categoryKey "okay" }}
            {{ $isSkippable := eq $categoryKey "skippable" }}

            {{ $awayTeam := "" }}{{ $homeTeam := "" }}
            {{ range $element.Competition.Teams }}
            {{ if eq .HomeAway "away" }}{{ $awayTeam = . }}{{ end }}
            {{ if eq .HomeAway "home" }}{{ $homeTeam = . }}{{ end }}
            {{ end }}

            <div class="card bg-base-200 shadow-sm">
                <div class="p-4">
                    <!-- Top row: Teams + Badge -->
                    <div class="flex items-center gap-3 mb-3">
                        <!-- Away Team -->
                        <div class="flex items-center gap-2 flex-1 min-w-0">
                            <img src="{{$awayTeam.Team.LogoURL}}" class="w-10 h-10 flex-shrink-0" />
                            <span class="text-sm font-medium truncate">{{$awayTeam.Team.Name}}</span>
                        </div>

                        <span class="text-base-content/30 text-xs">@</span>

                        <!-- Home Team -->
                        <div class="flex items-center gap-2 flex-1 min-w-0 justify-end">
                            <span class="text-sm font-medium truncate text-right">{{$homeTeam.Team.Name}}</span>
                            <img src="{{$homeTeam.Team.LogoURL}}" class="w-10 h-10 flex-shrink-0" />
                        </div>
                    </div>

                    <!-- Scores Row -->
                    <div class="flex items-center gap-2 mb-3">
                        <!-- Game Score -->
                        <div class="flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-lg bg-base-300/50">
                            <span class="text-[10px] uppercase text-base-content/50">Game</span>
                            {{ $score := .Rating.Score }}
                            {{ if eq $score 0 }}
                            <span class="loading loading-dots loading-xs"></span>
                            {{ else }}
                            <span class="text-lg font-bold {{ if ge $score 80 }}text-emerald-400{{ else if ge $score 65 }}text-teal-400{{ else if ge $score 50 }}text-amber-400{{ else }}text-rose-400{{ end }}">{{ $score }}</span>
                            {{ end }}
                        </div>

                        <!-- Fan Score -->
                        <div class="flex-1 flex items-center justify-center gap-2 py-2 px-3 rounded-lg bg-base-300/50">
                            <span class="text-[10px] uppercase text-base-content/50">Fans</span>
                            {{ if .Sentiment.HasData }}
                            <span class="text-lg font-bold {{ if ge .Sentiment.Score 80 }}text-emerald-400{{ else if ge .Sentiment.Score 65 }}text-teal-400{{ else if ge .Sentiment.Score 50 }}text-amber-400{{ else }}text-rose-400{{ end }}">{{ .Sentiment.Score }}</span>
                            {{ else }}
                            <span class="text-base-content/30">‚Äî</span>
                            {{ end }}
                        </div>

                        <!-- Badge -->
                        <span class="badge badge-sm {{ if $isMustWatch }}bg-emerald-600 border-emerald-600 text-white{{ else if $isRecommended }}bg-teal-600 border-teal-600 text-white{{ else if $isGood }}bg-slate-500 border-slate-500 text-white{{ else if $isOkay }}bg-amber-600 border-amber-600 text-white{{ else if $isSkippable }}bg-rose-600 border-rose-600 text-white{{ else }}badge-ghost{{ end }}">
                            {{ if $isMustWatch }}üî•{{ else if $isRecommended }}‚≠ê{{ else if $isGood }}üëç{{ else if $isOkay }}üòê{{ else if $isSkippable }}üëé{{ else }}‚Äî{{ end }}
                        </span>
                    </div>

                    <!-- Actions - Touch friendly -->
                    <div class="flex gap-2">
                        <button class="btn btn-ghost btn-sm flex-1" onclick="modalId('sf_{{ $element.ID }}')">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                            <span class="text-xs">Safe</span>
                        </button>
                        <button class="btn btn-ghost btn-sm flex-1" onclick="modalId('sp_{{ $element.ID }}')">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/></svg>
                            <span class="text-xs">Spoilers</span>
                        </button>
                        {{ if .Sentiment.HasData }}
                        <button class="btn btn-ghost btn-sm flex-1" onclick="modalId('fn_{{ $element.ID }}')">
                            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"/></svg>
                            <span class="text-xs">Fans</span>
                        </button>
                        {{ end }}
                    </div>
                </div>
            </div>

            <!-- Modals -->
            <dialog id="sf_{{ $element.ID }}" class="modal modal-bottom sm:modal-middle">
                <div class="modal-box">
                    <h3 class="font-bold text-lg mb-3">Spoiler-Free</h3>
                    <p class="text-base-content/80 text-sm leading-relaxed">{{ $element.Rating.SpoilerFree }}</p>
                    <div class="modal-action">
                        <form method="dialog"><button class="btn">Close</button></form>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>close</button></form>
            </dialog>

            <dialog id="sp_{{ $element.ID }}" class="modal modal-bottom sm:modal-middle">
                <div class="modal-box">
                    <h3 class="font-bold text-lg mb-3">Full Analysis</h3>
                    <div class="flex justify-center gap-6 py-3 mb-3 bg-base-200 rounded-lg">
                        <div class="text-center">
                            <div class="text-xs text-base-content/50 mb-1">{{$awayTeam.Team.Name}}</div>
                            <div class="text-2xl font-bold">{{ printf "%.0f" $awayTeam.Score }}</div>
                        </div>
                        <div class="text-base-content/30 self-center text-xl">-</div>
                        <div class="text-center">
                            <div class="text-xs text-base-content/50 mb-1">{{$homeTeam.Team.Name}}</div>
                            <div class="text-2xl font-bold">{{ printf "%.0f" $homeTeam.Score }}</div>
                        </div>
                    </div>
                    <p class="text-base-content/80 text-sm leading-relaxed">{{ $element.Rating.Explanation }}</p>
                    <div class="modal-action">
                        <form method="dialog"><button class="btn">Close</button></form>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>close</button></form>
            </dialog>

            {{ if .Sentiment.HasData }}
            <dialog id="fn_{{ $element.ID }}" class="modal modal-bottom sm:modal-middle">
                <div class="modal-box">
                    <h3 class="font-bold text-lg mb-3">Fan Reactions</h3>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="text-center p-3 bg-base-200 rounded-lg">
                            <div class="text-2xl font-bold text-emerald-400">{{ .Sentiment.Score }}</div>
                            <div class="text-[10px] uppercase text-base-content/50">Score</div>
                        </div>
                        <div class="text-center p-3 bg-base-200 rounded-lg">
                            <div class="text-lg font-semibold capitalize">{{ .Sentiment.Sentiment }}</div>
                            <div class="text-[10px] uppercase text-base-content/50">Mood</div>
                        </div>
                        <div class="text-center p-3 bg-base-200 rounded-lg">
                            <div class="text-lg font-semibold">{{ .Sentiment.CommentCount }}</div>
                            <div class="text-[10px] uppercase text-base-content/50">Comments</div>
                        </div>
                    </div>
                    <div class="mb-4">
                        <div class="text-xs font-semibold uppercase text-base-content/50 mb-2">Key Themes</div>
                        <ul class="text-sm text-base-content/70 space-y-1">
                            {{ range .Sentiment.Highlights }}<li>‚Ä¢ {{ . }}</li>{{ end }}
                        </ul>
                    </div>
                    <a href="{{ .Sentiment.ThreadURL }}" target="_blank" class="link link-hover text-xs text-base-content/60">View on Reddit ‚Üí</a>
                    <div class="modal-action">
                        <form method="dialog"><button class="btn">Close</button></form>
                    </div>
                </div>
                <form method="dialog" class="modal-backdrop"><button>close</button></form>
            </dialog>
            {{ end }}
            {{ end }}
        </div>
    </div>

    <!-- Browse Tab -->
    <div id="browse-content" class="tab-content hidden">
        <div class="px-4 py-6 max-w-lg mx-auto">
            <div class="space-y-4">
                <div class="form-control">
                    <label class="label pb-1"><span class="label-text text-xs uppercase tracking-wider">Season</span></label>
                    <select class="select select-bordered select-sm w-full" id="yearSelect">
                        {{ range $element := .Seasons }}<option value="{{ $element }}">{{ $element }}</option>{{ end }}
                    </select>
                </div>

                <div class="form-control">
                    <label class="label pb-1"><span class="label-text text-xs uppercase tracking-wider">Type</span></label>
                    <div class="grid grid-cols-3 gap-2">
                        <label class="btn btn-sm btn-outline has-[:checked]:btn-neutral">
                            <input type="radio" name="seasonType" value="regular" class="hidden" checked />Regular
                        </label>
                        <label class="btn btn-sm btn-outline has-[:checked]:btn-neutral">
                            <input type="radio" name="seasonType" value="playoff" class="hidden" />Playoffs
                        </label>
                        <label class="btn btn-sm btn-outline has-[:checked]:btn-neutral">
                            <input type="radio" name="seasonType" value="preseason" class="hidden" />Pre
                        </label>
                    </div>
                </div>

                <div class="form-control">
                    <label class="label pb-1"><span class="label-text text-xs uppercase tracking-wider">Week</span></label>
                    <div class="flex flex-wrap gap-2" id="weekGrid"></div>
                    <div id="weekData" class="hidden">
                        {{ range $element := .Dates }}
                        <span data-season="{{ $element.Season }}" data-week="{{ $element.Period }}" data-week-display="{{ $element.PeriodDisplay }}" data-season-type="{{ $element.PeriodType }}"></span>
                        {{ end }}
                    </div>
                </div>

                <button class="btn btn-neutral w-full mt-4" onclick="redirectToResults()">View Games</button>
            </div>
        </div>
    </div>

    <script>
        function modalId(id) { document.getElementById(id).showModal(); }
        let selectedWeek = null;

        function switchTab(tabName, el) {
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('tab-active'));
            document.getElementById(tabName + '-content').classList.remove('hidden');
            el.classList.add('tab-active');
            if (tabName === 'browse') { setCurrentValuesFromURL(); populateWeekGrid(); }
        }

        function setCurrentValuesFromURL() {
            const p = window.location.pathname.split('/').filter(x => x);
            if (p.length === 6 && p[0] === 'season') {
                document.getElementById('yearSelect').value = p[1];
                document.querySelectorAll('input[name="seasonType"]').forEach(r => {
                    r.checked = r.value === p[5];
                    r.closest('label').classList.toggle('btn-neutral', r.checked);
                    r.closest('label').classList.toggle('btn-outline', !r.checked);
                });
                selectedWeek = parseInt(p[3]);
            }
        }

        function populateWeekGrid() {
            const type = document.querySelector('input[name="seasonType"]:checked')?.value;
            const year = document.getElementById('yearSelect').value;
            const grid = document.getElementById('weekGrid');
            grid.innerHTML = '';
            const weeks = new Map();
            document.querySelectorAll('#weekData span').forEach(el => {
                if (el.dataset.season === year && el.dataset.seasonType === type) {
                    weeks.set(parseInt(el.dataset.week), el.dataset.weekDisplay);
                }
            });
            [...weeks.entries()].sort((a, b) => a[0] - b[0]).forEach(([week, display]) => {
                const btn = document.createElement('button');
                btn.className = 'btn btn-sm ' + (selectedWeek === week ? 'btn-neutral' : 'btn-outline');
                btn.textContent = display;
                btn.onclick = () => { selectedWeek = week; populateWeekGrid(); };
                grid.appendChild(btn);
            });
        }

        function redirectToResults() {
            const year = document.getElementById('yearSelect').value;
            const type = document.querySelector('input[name="seasonType"]:checked')?.value;
            if (!selectedWeek) { alert('Select a week'); return; }
            window.location.href = `/season/${year}/week/${selectedWeek}/type/${type}`;
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('input[name="seasonType"]').forEach(r => {
                r.addEventListener('change', () => {
                    document.querySelectorAll('input[name="seasonType"]').forEach(x => {
                        x.closest('label').classList.toggle('btn-neutral', x.checked);
                        x.closest('label').classList.toggle('btn-outline', !x.checked);
                    });
                    selectedWeek = null;
                    populateWeekGrid();
                });
            });
            setCurrentValuesFromURL();
            // Show "Latest" button when not on root
            if (window.location.pathname !== '/') {
                document.getElementById('latestBtn')?.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>
